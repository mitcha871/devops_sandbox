name: Tofu Plan

on:  # This workflow only triggers on PRs targeting main thata have changes to the ch5 lambda test.
  pull-requests:
    branches: ["main"]
    paths: ["ch5/lambda_test/**"]

jobs:
  plan:
    name: "Tofu Plan"
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write  # Give the workflow permissions to write a comment on the PR
      id-token: write
      contents: read
    steps:
    - uses: actions/checkout@v2

    - uses: aws-actions/configure-aws-credentials@v3
      with:
        role-to-assume: ${{ secrets.LAMBDA_R_ROLE }}
        role-session-name: plan-${{ github.run_number }}-${{ github.actor }}
        aws-region: ap-southeast-2

    - uses: opentofu/setup-opentofu@v1

    - name: tofu plan
      id: plan
      working-directory: ch5/lambda_test
      # Locking is disabled as unnecessary for only running a plan
      run: |
        tofu init -no-color -input=false
        tofu plan -no-color -input=false -lock=false

    - uses: peter-evans/create-or-update-comment@v4
      if: always()
      env:
        RESULT_EMOJI: ${{ steps.plan.outcome == 'success' && '✔' || '⚠️' }}
      with:
        issue-number: ${{ github.event.pull_request.number }}
        body: |
          ## ${{ env.RESULT_EMOJI }} `tofu plan` output
          ```${{ steps.plan.outputs.stdout }}```
